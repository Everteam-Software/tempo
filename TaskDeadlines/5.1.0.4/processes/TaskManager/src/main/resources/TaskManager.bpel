<?xml version="1.0" encoding="UTF-8"?>
<!--
* Copyright (c) 2005-2006 Intalio inc.
*
* All rights reserved. This program and the accompanying materials
* are made available under the terms of the Eclipse Public License v1.0
* which accompanies this distribution, and is available at
* http://www.eclipse.org/legal/epl-v10.html
*
* Contributors:
* Intalio inc. - initial API and implementation
-->
<process name="TaskManager"
         targetNamespace="http://www.intalio.com/bpms/workflow/ib4p_20051115"
         xmlns:bpws="http://schemas.xmlsoap.org/ws/2004/03/business-process/"
         xmlns="http://schemas.xmlsoap.org/ws/2004/03/business-process/"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
         xmlns:fn="http://www.w3.org/2005/xpath-functions"
         xmlns:tms="http://www.intalio.com/BPMS/Workflow/TaskManagementServices-20051109/"
         xmlns:b4p="http://www.intalio.com/bpms/workflow/ib4p_20051115"
         xmlns:b4px="java:org.intalio.tempo.workflow.processes.xpath.UID"
         xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
         xmlns:ode="http://www.apache.org/ode/type/extension">

    <import namespace="http://www.intalio.com/bpms/workflow/ib4p_20051115" location="TaskManager.wsdl"
            importType="http://schemas.xmlsoap.org/wsdl/"/>

    <partnerLinks>
        <partnerLink name="userProcessPartnerLink" partnerLinkType="b4p:userProcessPartnerLinkType" myRole="taskManager"
                     partnerRole="userProcess" initializePartnerRole="no"/>
        <partnerLink name="uifwPartnerLink" partnerLinkType="b4p:uifwPartnerLinkType" myRole="taskManager"/>
        <partnerLink name="TMSPartnerLink" partnerLinkType="b4p:TMSPartnerLinkType" partnerRole="TMS"
                     initializePartnerRole="yes"/>
        <partnerLink name="previousTaskManagerPartnerLink" partnerLinkType="b4p:taskManagerPartnerLinkType"
                     partnerRole="previousTaskManager" initializePartnerRole="yes"/>
        <partnerLink name="nextTaskManagerPartnerLink" partnerLinkType="b4p:taskManagerPartnerLinkType"
                     myRole="nextTaskManager"/>
    </partnerLinks>

    <variables>
        <variable name="createTaskRequest" messageType="b4p:createTaskRequest"/>
        <variable name="createTaskResponse" messageType="b4p:createTaskResponse"/>
        <variable name="createRequest" messageType="tms:createRequest"/>
        <variable name="createResponse" messageType="tms:okResponse"/>
        <variable name="escalateTaskRequest" messageType="b4p:escalateTaskRequest"/>
        <variable name="escalateTaskResponse" messageType="b4p:escalateTaskResponse"/>
        <variable name="reassignRequest" messageType="tms:reassignRequest"/>
        <variable name="reassignResponse" messageType="tms:okResponse"/>
        <variable name="completeTaskRequest" messageType="b4p:completeTaskRequest"/>
        <variable name="completeTaskResponse" messageType="b4p:completeTaskResponse"/>
        <variable name="claimTaskRequest" messageType="b4p:claimTaskRequest"/>
        <variable name="claimTaskResponse" messageType="b4p:claimTaskResponse"/>
        <variable name="revokeTaskRequest" messageType="b4p:revokeTaskRequest"/>
        <variable name="revokeTaskResponse" messageType="b4p:revokeTaskResponse"/>
        <variable name="notifyTaskCompletionRequest" messageType="b4p:notifyTaskCompletionRequest"/>
        <variable name="notifyTaskCompletionResponse" messageType="b4p:notifyTaskCompletionResponse"/>
        <variable name="setOutputAndCompleteRequest" messageType="tms:setOutputAndCompleteRequest"/>
        <variable name="setOutputAndCompleteResponse" messageType="tms:okResponse"/>
        <variable name="nextTaskReady" messageType="b4p:nextTaskReady"/>
        <variable name="taskCompleted" type="xsd:boolean"/>
        <variable name="taskEscalated" type="xsd:boolean"/>
        <variable name="taskClaimed" type="xsd:boolean"/>
        <variable name="initialOwners" messageType="b4p:usersAndRoles"/>
    </variables>

    <scope name="CreateAndCompleteTask">

        <correlationSets>
            <correlationSet name="task" properties="b4p:taskId"/>
            <correlationSet name="userProcess" properties="b4p:processId"/>
        </correlationSets>

        <sequence>

            <!-- Receive request to create new task -->

            <receive name="createTaskRequest"
                     partnerLink="userProcessPartnerLink"
                     portType="b4p:userProcessPortType"
                     operation="createTask"
                     variable="createTaskRequest"
                     createInstance="yes">
            </receive>

            <assign name="assignCreateTaskResponse">
                <copy>
                    <from>
                        <literal>
                            <b4p:response>
                                <b4p:taskMetaData>
                                    <b4p:taskId/>
                                    <b4p:processId/>
                                </b4p:taskMetaData>
                                <b4p:status>OK</b4p:status>
                            </b4p:response>
                        </literal>
                    </from>
                    <to variable="createTaskResponse" part="root"/>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskMetaData/b4p:processId</from>
                    <to>$createTaskResponse.root/b4p:taskMetaData/b4p:processId</to>
                </copy>
                <copy xmlns:b4px="java:org.intalio.tempo.workflow.processes.xpath.UID">
                    <from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">concat(b4px:create(),
                        $ode:pid)
                    </from>
                    <to>$createTaskResponse.root/b4p:taskMetaData/b4p:taskId</to>
                </copy>
            </assign>

            <reply name="createTaskResponse"
                   partnerLink="userProcessPartnerLink"
                   portType="b4p:userProcessPortType"
                   operation="createTask"
                   variable="createTaskResponse">
                <correlations>
                    <correlation set="task" initiate="yes"/>
                </correlations>
            </reply>

            <!-- Invoke TMS to create task -->

            <assign>
                <copy>
                    <from>
                        <literal>
                            <tms:createRequest>
                                <tms:task>
                                    <tms:metadata>
                                        <tms:taskId/>
                                        <tms:taskType>activity</tms:taskType>
                                        <tms:description/>
                                        <tms:processId/>
                                        <tms:creationDate/>
                                        <tms:userOwner/>
                                        <tms:roleOwner/>
                                        <tms:claimAction/>
                                        <tms:revokeAction/>
                                        <tms:saveAction/>
                                        <tms:completeAction/>
                                        <tms:formUrl/>
                                        <tms:userProcessEndpoint/>
                                        <tms:userProcessNamespaceURI/>
                                        <tms:userProcessCompleteSOAPAction/>
                                    </tms:metadata>
                                    <tms:input/>
                                </tms:task>
                                <tms:participantToken/>
                            </tms:createRequest>
                        </literal>
                    </from>
                    <to variable="createRequest" part="createRequest"/>
                </copy>
                <copy>
                    <from>$createTaskResponse.root/b4p:taskMetaData/b4p:taskId</from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:taskId</to>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskMetaData/b4p:description</from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:description</to>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskMetaData/b4p:processId</from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:processId</to>
                </copy>
                <copy>
                    <from>
                    bpws:doXslTransform("userRoleOwner.xsl", $createRequest.createRequest,
                                        "metadata", $createTaskRequest.root/b4p:taskMetaData)
                    </from>
                    <to>$createRequest.createRequest</to>
                </copy>
                <copy>
                    <from>
                    bpws:doXslTransform("actions.xsl", $createRequest.createRequest,
                                        "metadata", $createTaskRequest.root/b4p:taskMetaData)
                    </from>
                    <to>$createRequest.createRequest</to>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskMetaData/b4p:formUrl</from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:formUrl</to>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskInput</from>
                    <to>$createRequest.createRequest/tms:task/tms:input</to>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskMetaData/b4p:userProcessEndpoint</from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:userProcessEndpoint</to>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskMetaData/b4p:userProcessNamespaceURI</from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:userProcessNamespaceURI</to>
                </copy>
                <copy>
                    <from>$createTaskRequest.root/b4p:taskMetaData/b4p:userProcessCompleteSOAPAction</from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:userProcessCompleteSOAPAction</to>
                </copy>
                <copy>
                    <from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath2.0">
                        string(current-dateTime())
                    </from>
                    <to>$createRequest.createRequest/tms:task/tms:metadata/tms:creationDate</to>
                </copy>
            </assign>

            <invoke name="InvokeTMSToCreateTask"
                    operation="create"
                    inputVariable="createRequest"
                    outputVariable="createResponse"
                    partnerLink="TMSPartnerLink"
                    portType="tms:TaskManagementServices">
            </invoke>

            <!-- If this task follows a previous task (chained execution), then alert the previous Task Manager that this task is now created -->

            <if name="isChainedBefore">
                <condition>$createTaskRequest.root/b4p:taskMetaData/b4p:isChainedBefore = "true"</condition>

                <then>

                    <sequence>

                        <assign name="assignNextTaskReady">
                            <copy>
                                <from>
                                    <literal>
                                        <b4p:chainedExecution>
                                            <b4p:previousTaskId/>
                                            <b4p:nextTaskId/>
                                            <b4p:nextTaskURL/>
                                        </b4p:chainedExecution>
                                    </literal>
                                </from>
                                <to variable="nextTaskReady" part="root"/>
                            </copy>
                            <copy>
                                <from>$createTaskRequest.root/b4p:taskMetaData/b4p:previousTaskId</from>
                                <to>$nextTaskReady.root/b4p:previousTaskId</to>
                            </copy>
                            <copy>
                                <from>$createTaskResponse.root/b4p:taskMetaData/b4p:taskId</from>
                                <to>$nextTaskReady.root/b4p:nextTaskId</to>
                            </copy>
                            <copy>
                                <from>$createTaskRequest.root/b4p:taskMetaData/b4p:formUrl</from>
                                <to>$nextTaskReady.root/b4p:nextTaskURL</to>
                            </copy>
                        </assign>

                        <!-- Temporary solution while scheduler issue remains -->
                        <wait>
                            <for>'PT5S'</for>
                        </wait>

                        <invoke name="NotifyPreviousTaskManager"
                                operation="nextTaskReady"
                                inputVariable="nextTaskReady"
                                partnerLink="previousTaskManagerPartnerLink"
                                portType="b4p:taskManagerPortType">
                        </invoke>

                    </sequence>

                </then>
            </if>


            <assign name="initializeVarTaskCompleted">
                <copy>
                    <from>
                        <literal>false</literal>
                    </from>
                    <to variable="taskCompleted"/>
                </copy>
            </assign>
            <assign name="initializeVarTaskClaimed">
                <copy>
                    <from>
                        <literal>false</literal>
                    </from>
                    <to variable="taskClaimed"/>
                </copy>
            </assign>
            <assign name="initializeVarTaskEscalated">
                <copy>
                    <from>
                        <literal>false</literal>
                    </from>
                    <to variable="taskEscalated"/>
                </copy>
            </assign>
            <while>
                <condition>
                    $taskCompleted != "true"
                </condition>
                <pick createInstance="no">
                    <!-- Handle the "complete task" request -->
                    <onMessage partnerLink="uifwPartnerLink"
                               portType="b4p:uifwPortType" operation="completeTask"
                               variable="completeTaskRequest">
                        <correlations>
                            <correlation set="task" initiate="no"/>
                        </correlations>
                        <sequence>
                            <!-- Prepare response to UI -->
                            <assign name="assignCompleteTaskResponse">
                                <copy>
                                    <from>
                                        <literal>
                                            <b4p:response>
                                                <b4p:taskMetaData>
                                                    <b4p:taskId/>
                                                </b4p:taskMetaData>
                                                <b4p:status>
                                                    OK
                                                </b4p:status>
                                            </b4p:response>
                                        </literal>
                                    </from>
                                    <to variable="completeTaskResponse"
                                        part="root"/>
                                </copy>
                                <copy>
                                    <from>
                                        $completeTaskRequest.root/b4p:taskMetaData/b4p:taskId
                                    </from>
                                    <to>
                                        $completeTaskResponse.root/b4p:taskMetaData/b4p:taskId
                                    </to>
                                </copy>
                            </assign>
                            <!-- Invoke TMS to mark task as completed -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <tms:setOutputAndCompleteRequest>
                                                <tms:taskId/>
                                                <tms:data/>
                                                <tms:participantToken/>
                                            </tms:setOutputAndCompleteRequest>
                                        </literal>
                                    </from>
                                    <to
                                            variable="setOutputAndCompleteRequest"
                                            part="setOutputAndCompleteRequest"/>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskResponse.root/b4p:taskMetaData/b4p:taskId
                                    </from>
                                    <to>
                                        $setOutputAndCompleteRequest.setOutputAndCompleteRequest/tms:taskId
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $completeTaskRequest.root/b4p:taskOutput
                                    </from>
                                    <to>
                                        $setOutputAndCompleteRequest.setOutputAndCompleteRequest/tms:data
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $completeTaskRequest.root/b4p:participantToken
                                    </from>
                                    <to>
                                        $setOutputAndCompleteRequest.setOutputAndCompleteRequest/tms:participantToken
                                    </to>
                                </copy>
                            </assign>
                            <invoke operation="setOutputAndComplete"
                                    inputVariable="setOutputAndCompleteRequest"
                                    outputVariable="setOutputAndCompleteResponse"
                                    partnerLink="TMSPartnerLink"
                                    portType="tms:TaskManagementServices">
                            </invoke>
                            <!-- Route task output back to user process -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <b4p:notifyTaskCompletionRequest>
                                                <b4p:taskMetaData>
                                                    <b4p:taskId/>
                                                    <b4p:processId/>
                                                    <b4p:userProcessEndpoint/>
                                                    <b4p:userProcessNamespaceURI/>
                                                    <b4p:userProcessCompleteSOAPAction/>
                                                    <b4p:session/>
                                                </b4p:taskMetaData>
                                                <b4p:taskOutput/>
                                                <b4p:status>
                                                    OK
                                                </b4p:status>
                                            </b4p:notifyTaskCompletionRequest>
                                        </literal>
                                    </from>
                                    <to
                                            variable="notifyTaskCompletionRequest" part="root"/>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskResponse.root/b4p:taskMetaData/b4p:taskId
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskMetaData/b4p:taskId
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskRequest.root/b4p:taskMetaData/b4p:processId
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskMetaData/b4p:processId
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $completeTaskRequest.root/b4p:taskOutput
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskOutput
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskRequest.root/b4p:taskMetaData/b4p:userProcessEndpoint
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskMetaData/b4p:userProcessEndpoint
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskRequest.root/b4p:taskMetaData/b4p:userProcessEndpoint
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskMetaData/b4p:userProcessEndpoint
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskRequest.root/b4p:taskMetaData/b4p:userProcessNamespaceURI
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskMetaData/b4p:userProcessNamespaceURI
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskRequest.root/b4p:taskMetaData/b4p:userProcessCompleteSOAPAction
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskMetaData/b4p:userProcessCompleteSOAPAction
                                    </to>
                                </copy>
                                <copy>
                                    <from>
                                        $createTaskRequest.root/b4p:taskMetaData/b4p:session
                                    </from>
                                    <to>
                                        $notifyTaskCompletionRequest.root/b4p:taskMetaData/b4p:session
                                    </to>
                                </copy>
                            </assign>
                            <!-- send back notification via Form Dispatcher (FDS) -->
                            <!--assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <service-ref>
                                                <soap:address
                                                        location="http://localhost:8080/fds/workflow/ib4p"/>
                                            </service-ref>
                                        </literal>
                                    </from>
                                    <to
                                            partnerLink="userProcessPartnerLink"/>
                                </copy>
                            </assign-->
                            <invoke operation="notifyTaskCompletion"
                                    inputVariable="notifyTaskCompletionRequest"
                                    outputVariable="notifyTaskCompletionResponse"
                                    partnerLink="userProcessPartnerLink"
                                    portType="b4p:userProcessPortType">
                                <!--correlations>
                                    <correlation set="task"
                                                 pattern="request"/>
                                </correlations-->
                            </invoke>
                            <!-- If this task is chained to another task, then we wait for the
                                       next Task Manager to create that task and provide us with the
                                       next task ID so that the UI can directly show the next form -->
                            <if name="isChainedAfter">
                                <condition>
                                    $notifyTaskCompletionResponse.root/b4p:isChainedAfter
                                    = "true"
                                </condition>
                                <then>
                                    <sequence>
                                        <receive
                                                name="WaitForNextTaskManager" operation="nextTaskReady"
                                                variable="nextTaskReady" partnerLink="nextTaskManagerPartnerLink"
                                                portType="b4p:taskManagerPortType">
                                            <correlations>
                                                <correlation set="task"
                                                             initiate="no"/>
                                            </correlations>
                                        </receive>
                                        <assign
                                                name="CreateChainedTaskResponse">
                                            <copy>
                                                <from>
                                                    <literal>
                                                        <b4p:response>
                                                            <b4p:taskMetaData>
                                                                <b4p:nextTaskId/>
                                                                <b4p:nextTaskURL/>
                                                            </b4p:taskMetaData>
                                                            <b4p:status>
                                                                OK
                                                            </b4p:status>
                                                        </b4p:response>
                                                    </literal>
                                                </from>
                                                <to
                                                        variable="completeTaskResponse" part="root"/>
                                            </copy>
                                            <copy>
                                                <from>
                                                    $nextTaskReady.root/b4p:nextTaskId
                                                </from>
                                                <to>
                                                    $completeTaskResponse.root/b4p:taskMetaData/b4p:nextTaskId
                                                </to>
                                            </copy>
                                            <copy>
                                                <from>
                                                    $nextTaskReady.root/b4p:nextTaskURL
                                                </from>
                                                <to>
                                                    $completeTaskResponse.root/b4p:taskMetaData/b4p:nextTaskURL
                                                </to>
                                            </copy>
                                        </assign>
                                    </sequence>
                                </then>
                            </if>
                            <!-- Confirm Completion back to UI -->
                            <reply name="completeTaskResponse"
                                   partnerLink="uifwPartnerLink" portType="b4p:uifwPortType"
                                   operation="completeTask" variable="completeTaskResponse">
                            </reply>
                            <!-- Set the "task completed" flag to leave the upper-level while-loop -->
                            <assign name="markTaskAsCompleted">
                                <copy>
                                    <from>
                                        <literal>true</literal>
                                    </from>
                                    <to variable="taskCompleted"/>
                                </copy>
                            </assign>
                        </sequence>
                    </onMessage>
                    <!-- Handle the "escalate task" request -->
                    <onMessage partnerLink="userProcessPartnerLink"
                               portType="b4p:userProcessPortType"
                               operation="escalateTask"
                               variable="escalateTaskRequest">
                        <correlations>
                            <correlation set="task" initiate="no"/>
                        </correlations>
                        <sequence>
                            <!-- Prepare the reassignment request for TMS -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <tms:reassignRequest>
                                                <tms:taskId/>
                                                <tms:userOwner/>
                                                <tms:roleOwner/>
                                                <tms:taskState>READY</tms:taskState>
                                                <tms:participantToken/>
                                            </tms:reassignRequest>
                                        </literal>
                                    </from>
                                    <to variable="reassignRequest" part="reassignRequest"/>
                                </copy>
                                <copy>
                                    <from>$escalateTaskRequest.root/b4p:taskId</from>
                                    <to>$reassignRequest.reassignRequest/tms:taskId</to>
                                </copy>
                                <copy>
                                    <from>$escalateTaskRequest.root/b4p:userOwner</from>
                                    <to>$reassignRequest.reassignRequest/tms:userOwner</to>
                                </copy>
                                <copy>
                                    <from>$escalateTaskRequest.root/b4p:roleOwner</from>
                                    <to>$reassignRequest.reassignRequest/tms:roleOwner</to>
                                </copy>
                            </assign>
                            <!-- Send the request to TMS -->
                            <invoke operation="reassign"
                                    inputVariable="reassignRequest"
                                    outputVariable="reassignResponse"
                                    partnerLink="TMSPartnerLink"
                                    portType="tms:TaskManagementServices">
                            </invoke>
                            <!-- Clear state Claimed of task if any -->
                            <assign name="markAsNotClaimed">
                                <copy>
                                    <from>
                                        <literal>false</literal>
                                    </from>
                                    <to>$taskClaimed</to>
                                </copy>
                            </assign>
                            <!-- Prepare the escalation response for the user process -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <b4p:escalateTaskResponse>
                                                <b4p:status>OK</b4p:status>
                                            </b4p:escalateTaskResponse>
                                        </literal>
                                    </from>
                                    <to variable="escalateTaskResponse" part="root"/>
                                </copy>
                            </assign>
                            <!-- Confirm escalation to the user process -->
                            <reply name="escalateTaskResponse"
                                   partnerLink="userProcessPartnerLink" portType="b4p:userProcessPortType"
                                   operation="escalateTask" variable="escalateTaskResponse">
                            </reply>

                            <assign>
                                <copy>
                                    <from>
                                        <literal>true</literal>
                                    </from>
                                    <to>$taskEscalated</to>
                                </copy>
                            </assign>
                        </sequence>
                    </onMessage>
                    <!-- Handle the "claim task" request -->
                    <onMessage partnerLink="uifwPartnerLink"
                               portType="b4p:uifwPortType"
                               operation="claimTask"
                               variable="claimTaskRequest">
                        <correlations>
                            <correlation set="task" initiate="no"/>
                        </correlations>
                        <sequence>
                            <!-- Validate the request -->
                            <if>
                                <condition>$taskClaimed = "true"</condition>
                                <then>
                                    <throw faultName="b4p:taskAlreadyClaimed"/>
                                </then>
                            </if>
                            <!-- Save the previous owners of the task, to allow revoking in future -->
                            <if>
                                <condition>$taskEscalated = "true"</condition>
                                <then>
                                    <sequence>
                                        <assign name="saveInitialOwnersFromEscalation">
                                            <copy name="initialOwnersFromEscalation">
                                                <from>
                                                    <literal>
                                                        <b4p:usersAndRoles>
                                                            <b4p:userOwner/>
                                                            <b4p:roleOwner/>
                                                        </b4p:usersAndRoles>
                                                    </literal>
                                                </from>
                                                <to variable="initialOwners" part="root"/>
                                            </copy>
                                            <copy name="copyUserOwners1">
                                                <from>$escalateTaskRequest.root/b4p:userOwner</from>
                                                <to>$initialOwners.root//b4p:userOwner</to>
                                            </copy>
                                            <copy name="copyRoleOwners1">
                                                <from>$escalateTaskRequest.root/b4p:roleOwner</from>
                                                <to>$initialOwners.root//b4p:roleOwner</to>
                                            </copy>
                                        </assign>
                                    </sequence>
                                </then>
                                <else>
                                    <sequence>
                                        <assign name="saveInitialOwnersFromTaskCreate">
                                            <copy name="initialOwnersFromTaskCreate">
                                                <from>
                                                    <literal>
                                                        <b4p:usersAndRoles>
                                                            <b4p:userOwner/>
                                                            <b4p:roleOwner/>
                                                        </b4p:usersAndRoles>
                                                    </literal>
                                                </from>
                                                <to variable="initialOwners" part="root"/>
                                            </copy>
                                            <copy name="copyUserOwners2">
                                                <from>$createTaskRequest.root//b4p:userOwner</from>
                                                <to>$initialOwners.root//b4p:userOwner</to>
                                            </copy>
                                            <copy name="copyRoleOwners2">
                                                <from>$createTaskRequest.root//b4p:roleOwner</from>
                                                <to>$initialOwners.root//b4p:roleOwner</to>
                                            </copy>
                                        </assign>
                                    </sequence>
                                </else>
                            </if>
                            <!-- Prepare the reassign() request for TMS -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <tms:reassignRequest>
                                                <tms:taskId/>
                                                <tms:userOwner/>
                                                <tms:taskState>CLAIMED</tms:taskState>
                                                <tms:participantToken/>
                                            </tms:reassignRequest>
                                        </literal>
                                    </from>
                                    <to variable="reassignRequest" part="reassignRequest"/>
                                </copy>
                                <copy>
                                    <from>$claimTaskRequest.root/b4p:taskId</from>
                                    <to>$reassignRequest.reassignRequest/tms:taskId</to>
                                </copy>
                                <copy>
                                    <from>$claimTaskRequest.root/b4p:claimerUser</from>
                                    <to>$reassignRequest.reassignRequest/tms:userOwner</to>
                                </copy>
                                <copy>
                                    <from>$claimTaskRequest.root/b4p:participantToken</from>
                                    <to>$reassignRequest.reassignRequest/tms:participantToken</to>
                                </copy>
                            </assign>
                            <!-- Send the request to TMS -->
                            <invoke operation="reassign"
                                    inputVariable="reassignRequest"
                                    outputVariable="reassignResponse"
                                    partnerLink="TMSPartnerLink"
                                    portType="tms:TaskManagementServices">
                            </invoke>
                            <!-- Marking the task as CLAIMED -->
                            <assign name="markAsClaimed">
                                <copy>
                                    <from>
                                        <literal>true</literal>
                                    </from>
                                    <to>$taskClaimed</to>
                                </copy>
                            </assign>
                            <!-- Prepare the claim response for the user process -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <b4p:claimTaskResponse>
                                                <b4p:status>OK</b4p:status>
                                            </b4p:claimTaskResponse>
                                        </literal>
                                    </from>
                                    <to variable="claimTaskResponse" part="root"/>
                                </copy>
                            </assign>
                            <!-- Confirm claim to the user process -->
                            <reply name="claimTaskResponse"
                                   partnerLink="uifwPartnerLink" portType="b4p:uifwPortType"
                                   operation="claimTask" variable="claimTaskResponse">
                            </reply>
                            <!-- not setting the $taskCompleted variable to true,
                                        since the task is still not completed -->
                        </sequence>
                    </onMessage>
                    <!-- Handle the "revoke task" request -->
                    <onMessage partnerLink="uifwPartnerLink"
                               portType="b4p:uifwPortType"
                               operation="revokeTask"
                               variable="revokeTaskRequest">
                        <correlations>
                            <correlation set="task" initiate="no"/>
                        </correlations>
                        <sequence>
                            <!-- Validate the request -->
                            <if>
                                <condition>$taskClaimed != "true"</condition>
                                <then>
                                    <throw faultName="b4p:taskNotClaimed"/>
                                </then>
                            </if>
                            <!-- Prepare the reassign() request for TMS -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <tms:reassignRequest>
                                                <tms:taskId/>
                                                <tms:userOwner/>
                                                <tms:roleOwner/>
                                                <tms:taskState>READY</tms:taskState>
                                                <tms:participantToken/>
                                            </tms:reassignRequest>
                                        </literal>
                                    </from>
                                    <to variable="reassignRequest" part="reassignRequest"/>
                                </copy>
                                <copy>
                                    <from>$revokeTaskRequest.root/b4p:taskId</from>
                                    <to>$reassignRequest.reassignRequest/tms:taskId</to>
                                </copy>
                                <copy>
                                    <from>$initialOwners.root//b4p:userOwner</from>
                                    <to>$reassignRequest.reassignRequest/tms:userOwner</to>
                                </copy>
                                <copy>
                                    <from>$initialOwners.root//b4p:roleOwner</from>
                                    <to>$reassignRequest.reassignRequest/tms:roleOwner</to>
                                </copy>
                                <copy>
                                    <from>$revokeTaskRequest.root/b4p:participantToken</from>
                                    <to>$reassignRequest.reassignRequest/tms:participantToken</to>
                                </copy>
                            </assign>
                            <!-- Send the request to TMS -->
                            <invoke operation="reassign"
                                    inputVariable="reassignRequest"
                                    outputVariable="reassignResponse"
                                    partnerLink="TMSPartnerLink"
                                    portType="tms:TaskManagementServices">
                            </invoke>
                            <!-- Marking the task as NOT claimed -->
                            <assign name="markAsNotClaimed">
                                <copy>
                                    <from>
                                        <literal>false</literal>
                                    </from>
                                    <to>$taskClaimed</to>
                                </copy>
                            </assign>
                            <!-- Prepare the revoke response for the user process -->
                            <assign>
                                <copy>
                                    <from>
                                        <literal>
                                            <b4p:revokeTaskResponse>
                                                <b4p:status>OK</b4p:status>
                                            </b4p:revokeTaskResponse>
                                        </literal>
                                    </from>
                                    <to variable="revokeTaskResponse" part="root"/>
                                </copy>
                            </assign>
                            <!-- Confirm revoke to the user process -->
                            <reply name="revokeTaskResponse"
                                   partnerLink="uifwPartnerLink" portType="b4p:uifwPortType"
                                   operation="revokeTask" variable="revokeTaskResponse">
                            </reply>
                            <!-- not setting the $taskCompleted variable to true,
                                        since the task is still not completed -->
                        </sequence>
                    </onMessage>
                </pick>
            </while>
        </sequence>

    </scope>
</process>
